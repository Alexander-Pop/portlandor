<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\media\Entity\Media;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * Implements hook_form_alter().
 */
function portland_media_embed_helper_form_entity_embed_dialog_alter(array &$form, FormStateInterface $form_state, $form_id)
{
  // for embedded documents, images and videos using the entity_embed align and caption filters,
  // remove the filter fields from the embed form if the media item is a document.
  $hide_fields = true;
  // there should only be 1 element in the entities array, but just in case there
  // are more, don't hide the fields if one of them isn't a document.
  $entities = $form_state->getValue("entity_browser")["entities"] ;
  if (isset($entities)) {
    foreach($form_state->getValue("entity_browser")["entities"] as $entity) {
      if ($entity->bundle() != "document") {
        $hide_fields = false;
        break;
      }
    }
<<<<<<< HEAD
<<<<<<< HEAD
  }
  if ($hide_fields) {
    if (isset($form['attributes']['data-caption'])) unset($form['attributes']['data-caption']);
    if (isset($form['attributes']['data-align'])) unset($form['attributes']['data-align']);
  }
=======
    if ($hide_fields) {
      if (isset($form['attributes']['data-align'])) unset($form['attributes']['data-align']);
    }
    // always hide caption; it's configured in the media entity and not editable on a per-embed basis
    if (isset($form['attributes']['data-caption'])) unset($form['attributes']['data-caption']);
>>>>>>> POWR-918 Added new fields to image, video and audio media types; added Media License taxonomy

  if (isset($form['attributes']['data-align'])) {
    $img_100 =            "<img src=\"/themes/custom/cloudy/images/icons/img-100.png\" alt=\"100% width\" />";
    $img_50_right_fill =  "<img src=\"/themes/custom/cloudy/images/icons/img-50-fill.png\" alt=\"50% fill\" />";
    $img_50_right_fit =   "<img src=\"/themes/custom/cloudy/images/icons/img-50-fit.png\" alt=\"50% fit\" />";
    $embed_type = $form['attributes']['data-embed-button']['#value'];

    // clear default alignment options
    unset($form['attributes']['data-align']['#options']['left']);
    unset($form['attributes']['data-align']['#options']['right']);
    unset($form['attributes']['data-align']['#options']['center']);
    unset($form['attributes']['data-align']['#options']['']);

    $form['attributes']['data-align']['#title'] = "Alignment";
    $form['attributes']['data-align']['#default_value'] = "responsive-full";

    // full width applies to images and videos
    $form['attributes']['data-align']['#options']['responsive-full'] = "Full width<br>$img_100";

    // right fill and fit don't apply to videos
    if ($embed_type != "audio_video_browser") {
      $form['attributes']['data-align']['#options']['responsive-right'] = "50% fill<br>$img_50_right_fill";
      $form['attributes']['data-align']['#options']['right'] = "50% fit<br>$img_50_right_fit";
    } else {
      $form['attributes']['data-align']['#options']['responsive-right'] = "50% right<br>$img_50_right_fill";
=======
  }
  if ($hide_fields) {
    if (isset($form['attributes']['data-caption'])) unset($form['attributes']['data-caption']);
    if (isset($form['attributes']['data-align'])) unset($form['attributes']['data-align']);
  }

  // configure align options and add icons
  if (isset($form['attributes']['data-align'])) {
    $img_100 =            "<img src=\"/themes/custom/cloudy/images/icons/img-100.png\" alt=\"100% width\" />";
    $img_50_right_fill =  "<img src=\"/themes/custom/cloudy/images/icons/img-50-fill.png\" alt=\"50% fill\" />";
    $img_50_right_fit =   "<img src=\"/themes/custom/cloudy/images/icons/img-50-fit.png\" alt=\"50% fit\" />";
    $embed_type = $form['attributes']['data-embed-button']['#value'];

    // clear default alignment options
    unset($form['attributes']['data-align']['#options']['left']);
    unset($form['attributes']['data-align']['#options']['right']);
    unset($form['attributes']['data-align']['#options']['center']);
    unset($form['attributes']['data-align']['#options']['']);

    $form['attributes']['data-align']['#title'] = "Alignment";
    $form['attributes']['data-align']['#default_value'] = "responsive-full";

    // full width applies to images and videos
    $form['attributes']['data-align']['#options']['responsive-full'] = "Full width<br>$img_100";

    // right fill and fit don't apply to videos
    if ($embed_type != "audio_video_browser") {
      $form['attributes']['data-align']['#options']['responsive-right'] = "50% fill<br>$img_50_right_fill";
      $form['attributes']['data-align']['#options']['right'] = "50% fit<br>$img_50_right_fit";
    } else {
      $form['attributes']['data-align']['#options']['responsive-right'] = "50% right<br>$img_50_right_fill";
    }
  }

  // load selected media entity and get Caption value to provide as default value
  if (isset($form['attributes']['data-caption'])) {
    $input = $form_state->getUserInput();
    if (isset($input["entity_browser"]["entity_ids"])) {
      $media_id = $input["entity_browser"]["entity_ids"];
      $id = explode(":", $media_id);
      if (count($id) == 2) {
        $media = Media::load($id[1]);
        if ($media->hasField("field_caption")) {
          $form['attributes']['data-caption']["#default_value"] = $media->get("name")->value;
        }
      }
>>>>>>> POWR-918 Copied function from 841, load media type and set default caption value
    }
  }

  $form['#after_build'][] = 'portland_media_embed_helper_after_build';
}

function portland_media_embed_helper_after_build($form, &$form_state) {
  $form['actions']['back']['#value'] = t("Select a different entity");
  return $form;
}

/**
 * Implements hook_form_alter().
 * Causes media form submit to redirect to the group media page, if media is created in the context of a group.
 */
function portland_media_embed_helper_form_media_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $route_match = \Drupal::service('current_route_match');
  $group = $route_match->getParameter('group');
  if (isset($group)) {
    $form['actions']['submit']['#submit'][] = '_portland_media_embed_helper_redirect_to_group_media';
  }
}

function _portland_media_embed_helper_redirect_to_group_media(array $form, FormStateInterface $form_state) {
  $route_match = \Drupal::service('current_route_match');
  $group = $route_match->getParameter('group');
  $url = \Drupal::service('path.validator')->getUrlIfValid('/group/' . $group->id->value . '/media');
  $form_state->setRedirectUrl($url);
}

